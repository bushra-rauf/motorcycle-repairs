<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify Shops Data</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1000px; margin: 50px auto; padding: 20px; }
        .result { padding: 15px; margin: 10px 0; border-radius: 5px; border-left: 4px solid; }
        .success { background: #e8f5e9; border-color: #4caf50; }
        .error { background: #ffebee; border-color: #f44336; }
        .info { background: #e3f2fd; border-color: #2196f3; }
        .warning { background: #fff3cd; border-color: #ff9800; }
        button { padding: 12px 24px; background: #004e89; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 5px; font-size: 14px; }
        button:hover { background: #003d6b; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 5px; overflow-x: auto; max-height: 300px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center; }
        .stat-number { font-size: 2rem; font-weight: bold; color: #004e89; }
        .stat-label { color: #666; margin-top: 5px; }
    </style>
</head>
<body>
    <h1>üîç Verify Motorcycle Shops Database</h1>
    <p>This tool checks if your Supabase database has the correct motorcycle repair shop data.</p>

    <div class="warning result">
        <strong>Expected Data:</strong> Your CSV file has <strong>3,149 motorcycle repair shops</strong>
    </div>

    <button onclick="checkShopsData()">1. Check Database</button>
    <button onclick="showSampleData()">2. Show Sample Data</button>
    <button onclick="checkCountries()">3. Check Countries</button>
    <button onclick="clearResults()">Clear</button>

    <div id="stats" class="stats-grid" style="display: none;">
        <div class="stat-card">
            <div class="stat-number" id="totalShops">0</div>
            <div class="stat-label">Total Shops</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="totalCountries">0</div>
            <div class="stat-label">Countries</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="totalCities">0</div>
            <div class="stat-label">Cities</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="avgRating">0</div>
            <div class="stat-label">Avg Rating</div>
        </div>
    </div>

    <div id="results"></div>

    <script type="module">
        import { supabase } from './js/supabase.js';
        window.supabase = supabase;

        window.checkShopsData = async function() {
            addResult('Checking motorcycle_shops table...', 'info');

            try {
                // Get total count
                const { count, error: countError } = await supabase
                    .from('motorcycle_shops')
                    .select('*', { count: 'exact', head: true });

                if (countError) {
                    addResult(`‚ùå Error: ${countError.message}`, 'error');
                    return;
                }

                // Get unique countries and cities
                const { data: shops, error: dataError } = await supabase
                    .from('motorcycle_shops')
                    .select('country, city, rating');

                if (dataError) {
                    addResult(`‚ùå Error: ${dataError.message}`, 'error');
                    return;
                }

                const countries = [...new Set(shops.map(s => s.country).filter(Boolean))];
                const cities = [...new Set(shops.map(s => s.city).filter(Boolean))];

                const ratedShops = shops.filter(s => s.rating && !isNaN(parseFloat(s.rating)));
                const avgRating = ratedShops.length > 0
                    ? (ratedShops.reduce((sum, s) => sum + parseFloat(s.rating), 0) / ratedShops.length).toFixed(1)
                    : '0';

                // Show stats
                document.getElementById('stats').style.display = 'grid';
                document.getElementById('totalShops').textContent = count;
                document.getElementById('totalCountries').textContent = countries.length;
                document.getElementById('totalCities').textContent = cities.length;
                document.getElementById('avgRating').textContent = avgRating;

                // Verify count
                if (count === 3149) {
                    addResult(`‚úÖ PERFECT! Database has exactly ${count} shops (matches CSV)`, 'success');
                } else if (count > 0) {
                    addResult(`‚ö†Ô∏è Database has ${count} shops, but CSV has 3,149 shops`, 'warning');
                    addResult(`Difference: ${Math.abs(count - 3149)} shops ${count > 3149 ? 'extra' : 'missing'}`, 'warning');
                } else {
                    addResult(`‚ùå Database is EMPTY! You need to import the CSV data.`, 'error');
                    addResult(`<strong>How to import:</strong><br>
                        1. Go to Supabase Dashboard<br>
                        2. Click "Table Editor" ‚Üí "motorcycle_shops"<br>
                        3. Click "Insert" ‚Üí "Import data from CSV"<br>
                        4. Upload your eu_motorcycle_repairs_FIXED.csv file`, 'info');
                }

                addResult(`<strong>Database Statistics:</strong><br>
                    ‚Ä¢ Total Shops: ${count}<br>
                    ‚Ä¢ Countries: ${countries.length}<br>
                    ‚Ä¢ Cities: ${cities.length}<br>
                    ‚Ä¢ Average Rating: ${avgRating}`, 'info');

            } catch (error) {
                addResult(`‚ùå Exception: ${error.message}`, 'error');
                console.error(error);
            }
        };

        window.showSampleData = async function() {
            addResult('Fetching sample data from database...', 'info');

            try {
                const { data, error } = await supabase
                    .from('motorcycle_shops')
                    .select('name, address, city, country, rating, phone')
                    .limit(5);

                if (error) {
                    addResult(`‚ùå Error: ${error.message}`, 'error');
                    return;
                }

                if (data.length === 0) {
                    addResult('‚ùå No data found in database!', 'error');
                    return;
                }

                addResult(`‚úÖ Sample data (first 5 shops):<br><pre>${JSON.stringify(data, null, 2)}</pre>`, 'success');

            } catch (error) {
                addResult(`‚ùå Exception: ${error.message}`, 'error');
            }
        };

        window.checkCountries = async function() {
            addResult('Checking countries in database...', 'info');

            try {
                const { data, error } = await supabase
                    .from('motorcycle_shops')
                    .select('country');

                if (error) {
                    addResult(`‚ùå Error: ${error.message}`, 'error');
                    return;
                }

                const countryCounts = {};
                data.forEach(shop => {
                    const country = shop.country;
                    countryCounts[country] = (countryCounts[country] || 0) + 1;
                });

                const sortedCountries = Object.entries(countryCounts)
                    .sort((a, b) => b[1] - a[1])
                    .map(([country, count]) => `${country}: ${count} shops`)
                    .join('<br>');

                addResult(`‚úÖ Countries and shop counts:<br><pre>${sortedCountries}</pre>`, 'success');

            } catch (error) {
                addResult(`‚ùå Exception: ${error.message}`, 'error');
            }
        };

        window.addResult = function(message, type) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = message;
            results.appendChild(div);
        };

        window.clearResults = function() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('stats').style.display = 'none';
        };

        // Auto-check on load
        window.addEventListener('load', () => {
            setTimeout(checkShopsData, 500);
        });
    </script>
</body>
</html>
